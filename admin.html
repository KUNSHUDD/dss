<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户名提交管理系统</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .filter-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        select, button {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        button {
            background-color: #0366d6;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #035fc7;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .pending {
            background-color: #fff3cd;
        }
        .processed {
            background-color: #d4edda;
        }
        .action-btn {
            padding: 5px 10px;
            margin-right: 5px;
            border-radius: 3px;
            font-size: 14px;
        }
        .approve-btn {
            background-color: #28a745;
        }
        .reject-btn {
            background-color: #dc3545;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <h1>用户名提交管理系统</h1>
    
    <div class="filter-controls">
        <select id="statusFilter">
            <option value="all">所有状态</option>
            <option value="pending">待处理</option>
            <option value="processed">已处理</option>
        </select>
        <button onclick="loadIssues()">筛选</button>
        <button onclick="loadIssues()">刷新</button>
    </div>
    
    <div id="loading" class="loading">加载中...</div>
    <table id="issuesTable" style="display: none;">
        <thead>
            <tr>
                <th>ID</th>
                <th>用户名</th>
                <th>提交时间</th>
                <th>状态</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="issuesBody"></tbody>
    </table>

    <script>
        const token = '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';
        const repo = 'KUNSHUDD/dss';
        
        document.addEventListener('DOMContentLoaded', loadIssues);
        
        async function loadIssues() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('issuesTable').style.display = 'none';
            
            const statusFilter = document.getElementById('statusFilter').value;
            let url = `https://api.github.com/repos/${repo}/issues`;
            
            if (statusFilter === 'pending') {
                url += '?labels=pending';
            } else if (statusFilter === 'processed') {
                url += '?labels=processed';
            }
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) throw new Error('获取数据失败');
                
                const issues = await response.json();
                displayIssues(issues);
            } catch (error) {
                console.error('Error:', error);
                alert('加载数据时出错: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function displayIssues(issues) {
            const tbody = document.getElementById('issuesBody');
            tbody.innerHTML = '';
            
            if (issues.length === 0) {
                document.getElementById('issuesTable').style.display = 'none';
                document.getElementById('loading').textContent = '没有找到相关提交';
                document.getElementById('loading').style.display = 'block';
                return;
            }
            
            issues.forEach(issue => {
                const row = document.createElement('tr');
                
                // 从issue body中提取用户名和提交时间
                const usernameMatch = issue.body.match(/用户名:\s*(.+)/);
                const dateMatch = issue.body.match(/提交时间:\s*(.+)/);
                
                const username = usernameMatch ? usernameMatch[1] : '未知';
                const submitDate = dateMatch ? dateMatch[1] : '未知';
                
                // 检查状态
                const isPending = issue.labels.some(label => label.name === 'pending');
                const status = isPending ? '待处理' : '已处理';
                
                row.className = isPending ? 'pending' : 'processed';
                
                row.innerHTML = `
                    <td>${issue.number}</td>
                    <td>${username}</td>
                    <td>${submitDate}</td>
                    <td>${status}</td>
                    <td>
                        ${isPending ? `
                            <button class="action-btn approve-btn" onclick="processIssue(${issue.number}, 'approve')">通过</button>
                            <button class="action-btn reject-btn" onclick="processIssue(${issue.number}, 'reject')">拒绝</button>
                        ` : '已处理'}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            document.getElementById('issuesTable').style.display = 'table';
        }
        
        async function processIssue(issueNumber, action) {
            if (!confirm(`确定要${action === 'approve' ? '通过' : '拒绝'}这个提交吗？`)) return;
            
            try {
                // 首先获取当前issue以保留现有标签
                const getResponse = await fetch(`https://api.github.com/repos/${repo}/issues/${issueNumber}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getResponse.ok) throw new Error('获取issue详情失败');
                
                const issue = await getResponse.json();
                const currentLabels = issue.labels.map(label => label.name).filter(name => name !== 'pending');
                
                // 更新issue
                const response = await fetch(`https://api.github.com/repos/${repo}/issues/${issueNumber}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        labels: [...currentLabels, 'processed'],
                        state: action === 'approve' ? 'closed' : 'open'
                    })
                });
                
                if (!response.ok) throw new Error('处理提交失败');
                
                alert('处理成功！');
                loadIssues();
            } catch (error) {
                console.error('Error:', error);
                alert('处理时出错: ' + error.message);
            }
        }
    </script>
</body>
</html>
